# 鉴权后端设计文档

## 授权方式

参考OAuth，implicit mode



### 使用轮询

1. 浏览器`POST /oauth/authorize/`，POST一个json到服务端，json参数如下：
   * scopes: list of required scope names
2. 服务端回传一个json，描述内容如下：
   * code: 错误码
   * scopes: list of scope objects, describing itself
   * auth_code: 用于登陆的一串字符串
   * expire_at: 超时时间
3. 浏览器拿到上述信息，展示scopes中的表述，用二维码形式展示`auth_code`，要求用户使用小程序扫码登陆。
   同时，轮询`GET /oauth/authorize/<auth_code>/`。
4. 用户使用小程序扫码，得到`auth_code`，`GET /oauth/authorize/<auth_code>/`得到授权信息，向用户展示授权信息，等待用户确认，`POST /oauth/authorize/<>`
5. 小程序授权后，轮询将会得到一个json，其内容为：
   * access_token
   * expires_at
6. 之后需要鉴权的地方就在URL中带上一个参数`?access_token=<token>`即表示使用OAuth认证，否则使用session检查是否具有所需权限



## 后端设计

### 数据库
#### 鉴权流程相关
`OAuthRequest`

| field     | type     | description |
| --------- | -------- | ----------- |
| id        | int      | 自增ID      |
| client    | CHAR(32) |             |
| code      | CHAR(64) |             |
| expire_at | INT64    |             |
|           |          |             |



`OAuthReqScope`

| field    | type        | description                        |
| -------- | ----------- | ---------------------------------- |
| id       | int         | 自增ID                             |
| scopeid  | int | 对应scope                          |
| req_id   | int         | 关联到AuthRequest                  |
| token_id | int         | 初始为null，颁发token后关联到Token  |

`OAuthToken`

| field      | type     | description |
| ---------- | -------- | ----------- |
| id         | int      | 自增ID      |
| token      | CHAR(64) |             |
| expired_at | INT64    |             |
| authorizer | OpenID   | |

#### 权限配置相关
`Scope`
| field | type | description |
| ----- | ---- | ----------- |
| id | int | |
| scope | VARCHAR(64), unique |  |
| description | VARCHAR(4096) | |



`Privilege`

| field | type | description |
| ----- | ---- | ----------- |
| id | int | |
| openid | openid ||
| scope | Scope ||

特殊`Privilege`：

* profile：表示已经登录，所有用户默认具有这个权限

`Privilege`列表：

* `admin`

