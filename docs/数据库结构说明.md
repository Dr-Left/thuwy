# 数据库结构说明

## 管理员表

表名：`admin`

这个表只一列，存管理员的openid

| 字段名 | 类型 | 说明           |
| ------ | ---- | -------------- |
| openid | text | 管理员的openid |



## 管理员申请表

表名：`admin_req`

| 字段名    | 类型   | 说明                      |
| --------- | ------ | ------------------------- |
| id        | int    | 申请ID                    |
| requestor | string | 申请人的openid            |
| approver  | string | 批准人的openid            |
| state     | int    | 申请状态                  |
|           |        | 0：等待；1：批准；2：拒绝 |
| reason    | string | 审核批语                  |





## 用户表

表名：`user`

| 字段名    | 类型 | 说明       |
| --------- | ---- | ---------- |
| openid    | text | 用户openid |
| school_id | text | 学号       |
| name      | text | 姓名       |
| clazz     | text | 班级       |



## 设备表

表名：`item`

| 字段名      | 类型 | 说明                                     |
| ----------- | ---- | ---------------------------------------- |
| id          | int  | 设备ID                                   |
| name        | text | 设备名                                   |
| available   | int  | 是否可用，默认为 1，下架时为 0           |
| delete      | int  | 是否被删除，删除后不再被出现在设备列表中 |
| rsv_method  | int  | 支持的预约方法                           |
| brief_intro | text | 简要介绍                                 |
| thumbnail   | text | 缩略图的URL                              |
| md_intro    | text | markdown格式的详细介绍                   |
| attr        | int  | 特殊属性                                 |

**特殊属性说明：**

按位组合，每一位含义不同。每一位含义如下：

0. 自动审批通过
1. ……





## 订单表

表名：reservation

### 表结构

| 字段名   | 类型 | 说明                             |
| -------- | ---- | -------------------------------- |
| id       | int  | 订单id                           |
| item_id  | int  | 预约物品的ID                     |
| guest    | text | 预约者的openid                   |
| reason   | text | 预约原因                         |
| method   | int  | 使用的预约方法                   |
| st       | int  |                                  |
| ed       | int  | 预约开始/结束时间，64位linux时间 |
| state    | int  | 预约状态                         |
| approver | text | 审批人(管理员)的openid           |
| exam_rst | text | 审批批语                         |
| chore    | text | 附加信息，以json格式储存         |

### chore 作用

> 我们把所有的脏活都丢给chore吧 (｀・ω・´)



#### 实现时间段预约

一行rsv记录表示一段**时间连续**的预约，但是我们要支持长时间预约，时间是分段的，这个时候就用chore来实现这个功能。

**一个**时间段预约**订单**可以预约多段时间，例如`interval`的值为`['2021-2-16 1', '2021-2-17 2']`，我们就需要把这个订单拆分为多个时间段连续的预约，为了把这些记录联系起来，使用`chore`字段。



详细的说，时间段预约将被分解为**根预约**和**子预约**。根预约只有一个，连接到所有子预约；子预约有多个，连接到根预约。

如果预约表中的一条记录属于一个时间段预约订单，那么它的`chore`附加`group-rsv`属性，该属性为一个字典，具有如下两个属性之一：

* 若该记录为根预约，则有`sub-rsvs`属性，该属性为列表，包含所有子预约的`RsvId`
* 若该记录为子预约，则有`fth-rsv`属性，该属性为父预约的`RsvId`



#### 储存违规惩罚信息

还没想好是存在这还是在开一张表来存。



